{% comment %}
  Featured Products section - Product Recommendations API first, then fallback collection.
  Renders on product page. Fetches recommendations via Section Rendering API; if none, uses fallback collection from settings.
{% endcomment %}

{{ 'featured-products.css' | asset_url | stylesheet_tag }}
{{ 'component-slider.css' | asset_url | stylesheet_tag }}

{%- liquid
  if recommendations.performed? and recommendations.products_count > 0
    assign products_to_show = recommendations.products
  elsif section.settings.fallback_collection != blank
    assign products_to_show = section.settings.fallback_collection.products
  else
    assign products_to_show = null
  endif

  assign products_count = 0
  if products_to_show != blank and products_to_show.size > 0
    assign products_count = products_to_show.size
  endif

  assign show_desktop_slider = false
  assign show_mobile_slider = false
  if products_count > 4
    assign show_desktop_slider = true
  endif
  if products_count >= 2
    assign show_mobile_slider = true
  endif
  assign show_slider = false
  if show_desktop_slider or show_mobile_slider
    assign show_slider = true
  endif

  assign product_id = product.id | default: ''
-%}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<section
  class="featured-products section-{{ section.id }}-padding color-{{ section.settings.color_scheme }}"
  id="FeaturedProducts-{{ section.id }}"
  data-product-id="{{ product_id }}"
  data-section-id="{{ section.id }}"
  data-recommendations-url="{{ request.origin }}/recommendations/products"
  data-allow-auto-recommendations="{% if section.settings.allow_auto_generated_recommendations %}true{% else %}false{% endif %}"
>
  <div class="featured-products__container page-width">
    <div class="featured-products__header">
      <div class="featured-products__header-content">
        {%- if section.settings.title != blank -%}
          <h2 class="featured-products__title {{ section.settings.heading_size }}">{{ section.settings.title }}</h2>
        {%- endif -%}
        {%- if section.settings.description != blank -%}
          <div class="featured-products__description rte">{{ section.settings.description }}</div>
        {%- endif -%}
      </div>
      {%- if show_slider and products_count > 0 -%}
        <div class="featured-products__nav{% if products_count <= 4 %} featured-products__nav--mobile-only{% endif %}">
          <button
            type="button"
            class="featured-products__nav-btn featured-products__nav-btn--prev"
            name="previous"
            aria-label="{{ 'general.slider.previous_slide' | t }}"
            aria-controls="Slider-{{ section.id }}"
          >
            {% render 'icon-caret' %}
          </button>
          <button
            type="button"
            class="featured-products__nav-btn featured-products__nav-btn--next"
            name="next"
            aria-label="{{ 'general.slider.next_slide' | t }}"
            aria-controls="Slider-{{ section.id }}"
          >
            {% render 'icon-caret' %}
          </button>
        </div>
      {%- endif -%}
    </div>

    <div class="featured-products__content" id="FeaturedProductsContent-{{ section.id }}">
      {%- if products_count > 0 -%}
        <slider-component
          class="featured-products__slider{% if show_slider %} featured-products__slider--active{% endif %}{% if show_desktop_slider %} featured-products__slider--desktop{% endif %}{% if show_mobile_slider and products_count <= 4 %} featured-products__slider--mobile-only{% endif %}{% if show_mobile_slider and products_count > 4 %} featured-products__slider--mobile{% endif %}"
          {% if show_slider %}data-slider-active{% endif %}
        >
          <ul
            id="Slider-{{ section.id }}"
            class="featured-products__grid{% if show_desktop_slider %} slider slider--desktop{% endif %}{% if show_mobile_slider and products_count > 4 %} slider slider--tablet{% endif %}"
            role="list"
          >
            {%- for card_product in products_to_show limit: 10 -%}
              <li
                id="Slide-{{ section.id }}-{{ forloop.index }}"
                class="featured-products__grid-item{% if show_slider %} slider__slide{% endif %}"
              >
                {% render 'featured-product-card', card_product: card_product, section_id: section.id %}
              </li>
            {%- endfor -%}
          </ul>
          {%- if show_slider -%}
            <div class="slider-buttons no-js-hidden featured-products__slider-buttons">
              <button type="button" class="slider-button slider-button--prev" name="previous" aria-label="{{ 'general.slider.previous_slide' | t }}" aria-controls="Slider-{{ section.id }}">
                {% render 'icon-caret' %}
              </button>
              <button type="button" class="slider-button slider-button--next" name="next" aria-label="{{ 'general.slider.next_slide' | t }}" aria-controls="Slider-{{ section.id }}">
                {% render 'icon-caret' %}
              </button>
            </div>
          {%- endif -%}
        </slider-component>
      {%- else -%}
        <div class="featured-products__placeholder" data-featured-products-placeholder>
          <p class="featured-products__placeholder-text">Loading recommendations...</p>
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

<script src="{{ 'featured-products.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Featured products",
  "tag": "section",
  "class": "section-featured-products",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "Heading",
      "default": "Featured products"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Lorem ipsum odor amet, consectetuer adipiscing elit. Suscipit lectus cursus phasellus ridiculus nostra fames. Sollicitudin mi facilisi congue tellus dictumst eu ligula arcu. Vivamus luctus vel duis tempor curabitur potenti rhoncus. Orci dictum et varius feugiat pulvinar euismod iaculis diam. Lacus inceptos vel fusce interdum molestie luctus cubilia.</p>"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1",
      "label": "Heading size"
    },
    {
      "type": "collection",
      "id": "fallback_collection",
      "label": "Fallback collection",
      "info": "Display products using the Product Recommendations API first. If a product has no recommendations, fall back to the products specified here."
    },
    {
      "type": "checkbox",
      "id": "allow_auto_generated_recommendations",
      "label": "Use Shopify auto-generated recommendations",
      "info": "When unchecked: if there are no manual recommendations (Search & Discovery) and no fallback collection, the section stays empty. When checked: Shopify may show auto-generated recommendations (e.g. 4 products) when none are set.",
      "default": true
    },
    {
      "type": "select",
      "id": "color_scheme",
      "options": [
        { "value": "accent-1", "label": "Accent 1" },
        { "value": "accent-2", "label": "Accent 2" },
        { "value": "background-1", "label": "Background 1" },
        { "value": "background-2", "label": "Background 2" },
        { "value": "inverse", "label": "Inverse" }
      ],
      "default": "background-1",
      "label": "Color scheme"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Featured products",
      "settings": {
        "title": "Featured products",
        "description": "<p>Lorem ipsum odor amet, consectetuer adipiscing elit. Suscipit lectus cursus phasellus ridiculus nostra fames. Sollicitudin mi facilisi congue tellus dictumst eu ligula arcu. Vivamus luctus vel duis tempor curabitur potenti rhoncus. Orci dictum et varius feugiat pulvinar euismod iaculis diam. Lacus inceptos vel fusce interdum molestie luctus cubilia.</p>"
      }
    }
  ]
}
{% endschema %}

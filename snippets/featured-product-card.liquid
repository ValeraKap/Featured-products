{% comment %}
  Renders a product card for Featured Products section
  Accepts:
  - card_product: {Object} Product Liquid object
  - section_id: {String} Section ID
{% endcomment %}

{%- if card_product and card_product != empty -%}
  {%- liquid
    assign variant = card_product.selected_or_first_available_variant
    assign compare_at_price = variant.compare_at_price
    assign price = variant.price
    assign has_sale = false
    if compare_at_price and compare_at_price > price
      assign has_sale = true
      assign discount_amount = compare_at_price | minus: price
    endif

    assign description_text = card_product.description | strip_html | strip
    assign desc_lines = description_text | newline_to_br | split: '<br />'
    assign description_first_line = desc_lines | first | strip
    if description_first_line.size > 80
      assign description_display = description_first_line | truncate: 80, "...."
    else
      assign description_display = description_first_line
    endif

    assign rating_value = card_product.metafields.reviews.rating.value
  -%}

  <article class="featured-products__card">
    <a href="{{ card_product.url }}" class="featured-products__card-link">
      <div class="featured-products__card-image-wrapper">
        <div class="featured-products__card-image ratio" style="--ratio-percent: 100%;">
          {%- if card_product.featured_media -%}
            <img
              src="{{ card_product.featured_media | image_url: width: 400 }}"
              srcset="{{ card_product.featured_media | image_url: width: 200 }} 200w,
                      {{ card_product.featured_media | image_url: width: 400 }} 400w,
                      {{ card_product.featured_media | image_url: width: 600 }} 600w"
              sizes="(min-width: 990px) 25vw, (min-width: 750px) 33vw, 50vw"
              alt="{{ card_product.featured_media.alt | escape }}"
              loading="lazy"
              width="400"
              height="400"
              class="featured-products__card-img"
            >
          {%- else -%}
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg featured-products__card-placeholder' }}
          {%- endif -%}
        </div>

        {%- if has_sale -%}
          <span class="featured-products__badge featured-products__badge--sale">
            Save {{ discount_amount | money }}
          </span>
        {%- elsif card_product.available -%}
          <span class="featured-products__badge featured-products__badge--new">New</span>
        {%- endif -%}
      </div>

      <div class="featured-products__card-content">
        <div class="featured-products__rating" role="img" aria-label="Rating 4.9 out of 5">
          {%- if rating_value != blank -%}
            {%- liquid
              assign rating_decimal = 0
              assign decimal = rating_value.rating | modulo: 1
              if decimal >= 0.3 and decimal <= 0.7
                assign rating_decimal = 0.5
              elsif decimal > 0.7
                assign rating_decimal = 1
              endif
              assign display_rating = rating_value.rating
              assign display_scale = rating_value.scale_max
            -%}
            <span class="featured-products__stars" style="--rating: {{ rating_value.rating | floor }}; --rating-max: {{ rating_value.scale_max }}; --rating-decimal: {{ rating_decimal }};"></span>
            <span class="featured-products__rating-value">{{ rating_value.rating }}</span>
          {%- else -%}
            <span class="featured-products__stars" style="--rating: 5; --rating-max: 5; --rating-decimal: 0;"></span>
            <span class="featured-products__rating-value">4.9+</span>
          {%- endif -%}
        </div>

        <h3 class="featured-products__card-title">{{ card_product.title | escape }}</h3>

        {%- if description_display != blank -%}
          <p class="featured-products__card-description">{{ description_display }}</p>
        {%- endif -%}

        <div class="featured-products__card-price">
          {%- if has_sale -%}
            <s class="featured-products__price-compare">{{ compare_at_price | money }}</s>
            <span class="featured-products__price-sale">{{ price | money }}</span>
          {%- else -%}
            <span class="featured-products__price-regular">{{ price | money }}</span>
          {%- endif -%}
        </div>
      </div>
    </a>
  </article>
{%- endif -%}
